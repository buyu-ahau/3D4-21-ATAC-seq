
# åŠ è½½åŒ…
suppressPackageStartupMessages({
  library(rtracklayer)
  library(GenomicRanges)
  library(IRanges)
  library(dplyr)
  library(ggplot2)
})

cat("âœ“ æ‰€æœ‰åŒ…åŠ è½½æˆåŠŸ\n\n")

# è®¾ç½®å·¥ä½œç›®å½•
å·¥ä½œç›®å½• <- "K:/ATAC-seq é‡æ–°åˆ†æ8.5"
setwd(å·¥ä½œç›®å½•)
cat("âœ“ å·¥ä½œç›®å½•è®¾ç½®ä¸º:", getwd(), "\n")

# åˆ›å»ºè¾“å‡ºç›®å½•
è¾“å‡ºç›®å½• <- "åŸºå› æ³¨é‡Šåˆ†æç»“æœ"
dir.create(è¾“å‡ºç›®å½•, showWarnings = FALSE)
dir.create(file.path(è¾“å‡ºç›®å½•, "ç»“æœ"), showWarnings = FALSE)
dir.create(file.path(è¾“å‡ºç›®å½•, "å›¾è¡¨"), showWarnings = FALSE)
dir.create(file.path(è¾“å‡ºç›®å½•, "åŸºå› åˆ—è¡¨"), showWarnings = FALSE)

# è®¾ç½®æ–‡ä»¶è·¯å¾„
cat("\n=== æ£€æŸ¥è¾“å…¥æ–‡ä»¶ ===\n")
edgeR_å®½æ¾_æ–‡ä»¶ <- "EdgeR_å®½æ¾é˜ˆå€¼_æ˜¾è‘—åŒºåŸŸ.csv"
edgeR_ä¸¥æ ¼_æ–‡ä»¶ <- "EdgeR_ä¸¥æ ¼é˜ˆå€¼_æ˜¾è‘—åŒºåŸŸ.csv" 
gtf_æ–‡ä»¶ <- "Sus_scrofa.Sscrofa11.1.114.chr.gtf.gz"

# æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
æ–‡ä»¶åˆ—è¡¨ <- c(edgeR_å®½æ¾_æ–‡ä»¶, edgeR_ä¸¥æ ¼_æ–‡ä»¶, gtf_æ–‡ä»¶)
for(æ–‡ä»¶ in æ–‡ä»¶åˆ—è¡¨) {
  if(file.exists(æ–‡ä»¶)) {
    æ–‡ä»¶å¤§å° <- file.size(æ–‡ä»¶)
    cat("âœ“ æ‰¾åˆ°æ–‡ä»¶:", æ–‡ä»¶, "å¤§å°:", round(æ–‡ä»¶å¤§å°/1024/1024, 2), "MB\n")
  } else {
    cat("âœ— ç¼ºå°‘æ–‡ä»¶:", æ–‡ä»¶, "\n")
  }
}

# è¯»å–EdgeRå·®å¼‚åˆ†æç»“æœ
cat("\n=== è¯»å–EdgeRå·®å¼‚åˆ†æç»“æœ ===\n")

# è¯»å–å®½æ¾é˜ˆå€¼ç»“æœ
if(file.exists(edgeR_å®½æ¾_æ–‡ä»¶)) {
  edgeR_å®½æ¾ <- read.csv(edgeR_å®½æ¾_æ–‡ä»¶, stringsAsFactors = FALSE)
  cat("âœ“ EdgeRå®½æ¾é˜ˆå€¼ç»“æœè¯»å–æˆåŠŸ:", nrow(edgeR_å®½æ¾), "ä¸ªåŒºåŸŸ\n")
  cat("  åˆ—å:", paste(colnames(edgeR_å®½æ¾), collapse = ", "), "\n")
} else {
  stop("é”™è¯¯: æœªæ‰¾åˆ°EdgeRå®½æ¾é˜ˆå€¼ç»“æœæ–‡ä»¶")
}

# è¯»å–ä¸¥æ ¼é˜ˆå€¼ç»“æœ
if(file.exists(edgeR_ä¸¥æ ¼_æ–‡ä»¶)) {
  edgeR_ä¸¥æ ¼ <- read.csv(edgeR_ä¸¥æ ¼_æ–‡ä»¶, stringsAsFactors = FALSE)
  cat("âœ“ EdgeRä¸¥æ ¼é˜ˆå€¼ç»“æœè¯»å–æˆåŠŸ:", nrow(edgeR_ä¸¥æ ¼), "ä¸ªåŒºåŸŸ\n")
  if(nrow(edgeR_ä¸¥æ ¼) > 0) {
    cat("  åˆ—å:", paste(colnames(edgeR_ä¸¥æ ¼), collapse = ", "), "\n")
  }
} else {
  edgeR_ä¸¥æ ¼ <- data.frame()
  cat("! EdgeRä¸¥æ ¼é˜ˆå€¼ç»“æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ›å»ºç©ºæ•°æ®æ¡†\n")
}

# è¯»å–GTFæ–‡ä»¶
cat("\n=== è¯»å–çŒªåŸºå› ç»„GTFæ–‡ä»¶ ===\n")
if(file.exists(gtf_æ–‡ä»¶)) {
  cat("æ­£åœ¨è¯»å–å‹ç¼©GTFæ–‡ä»¶ï¼ˆè¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿï¼‰...\n")
  
  # ä½¿ç”¨tryCatchå¤„ç†å¯èƒ½çš„ç¼–ç é—®é¢˜
  tryCatch({
    gtf_gr <- import(gtf_æ–‡ä»¶)
    genes_gr <- gtf_gr[gtf_gr$type == "gene"]
    cat("âœ“ è¯»å–åˆ°", length(genes_gr), "ä¸ªåŸºå› \n")
    
    # æ£€æŸ¥åŸºå› ä¿¡æ¯çš„åˆ—
    cat("åŸºå› ä¿¡æ¯åˆ—å:", paste(colnames(mcols(genes_gr)), collapse = ", "), "\n")
    
    # æ˜¾ç¤ºå‰3ä¸ªåŸºå› çš„åŸºæœ¬ä¿¡æ¯
    cat("\nå‰3ä¸ªåŸºå› é¢„è§ˆ:\n")
    for(i in 1:min(3, length(genes_gr))) {
      gene_info <- genes_gr[i]
      cat(sprintf("åŸºå› %d: %s:%d-%d (%s) - %s\n", 
                  i, 
                  as.character(seqnames(gene_info)), 
                  start(gene_info), 
                  end(gene_info),
                  as.character(strand(gene_info)),
                  ifelse(is.null(gene_info$gene_name), "æ— åç§°", gene_info$gene_name)))
    }
    
  }, error = function(e) {
    cat("è¯»å–GTFæ–‡ä»¶æ—¶å‡ºé”™:", e$message, "\n")
    cat("å°è¯•å…¶ä»–æ–¹æ³•...\n")
    stop("GTFæ–‡ä»¶è¯»å–å¤±è´¥")
  })
  
} else {
  stop("é”™è¯¯: æœªæ‰¾åˆ°GTFæ–‡ä»¶")
}

# å®šä¹‰åŸºå› æ³¨é‡Šå‡½æ•°
annotate_peaks_windows <- function(peak_data, peak_type, genes_gr, output_dir) {
  cat(sprintf("\n=== %så³°å€¼åŸºå› æ³¨é‡Š ===\n", peak_type))
  
  if(nrow(peak_data) == 0) {
    cat("! æ²¡æœ‰å³°å€¼éœ€è¦æ³¨é‡Š\n")
    return(NULL)
  }
  
  cat("æ­£åœ¨å¤„ç†", nrow(peak_data), "ä¸ªå³°å€¼...\n")
  
  # è½¬æ¢å³°å€¼ä¸ºGRangeså¯¹è±¡
  peaks_gr <- GRanges(
    seqnames = peak_data$seqnames,
    ranges = IRanges(start = peak_data$start, end = peak_data$end),
    strand = "*",
    fold_change = peak_data$Fold,
    fdr = peak_data$FDR,
    peak_id = paste0("Peak_", 1:nrow(peak_data))
  )
  
  cat("æ­£åœ¨æŸ¥æ‰¾æœ€è¿‘åŸºå› ...\n")
  
  # æ‰¾åˆ°æ¯ä¸ªå³°å€¼æœ€è¿‘çš„åŸºå› 
  nearest_indices <- nearest(peaks_gr, genes_gr)
  
  # å¤„ç†æ²¡æœ‰æ‰¾åˆ°æœ€è¿‘åŸºå› çš„æƒ…å†µ
  valid_indices <- !is.na(nearest_indices)
  
  cat("æˆåŠŸæ³¨é‡Š", sum(valid_indices), "ä¸ªå³°å€¼\n")
  
  # è®¡ç®—åˆ°TSSçš„è·ç¦»
  tss_positions <- rep(NA, length(peaks_gr))
  tss_positions[valid_indices] <- ifelse(
    strand(genes_gr[nearest_indices[valid_indices]]) == "+", 
    start(genes_gr[nearest_indices[valid_indices]]), 
    end(genes_gr[nearest_indices[valid_indices]])
  )
  
  peak_centers <- start(peaks_gr) + (end(peaks_gr) - start(peaks_gr))/2
  distance_to_tss <- peak_centers - tss_positions
  
  # åˆ›å»ºæ³¨é‡Šç»“æœ
  anno_df <- data.frame(
    seqnames = as.character(seqnames(peaks_gr)),
    start = start(peaks_gr),
    end = end(peaks_gr),
    width = width(peaks_gr),
    peak_id = peaks_gr$peak_id,
    fold_change = peaks_gr$fold_change,
    fdr = peaks_gr$fdr,
    distanceToTSS = distance_to_tss,
    stringsAsFactors = FALSE
  )
  
  # æ·»åŠ åŸºå› ä¿¡æ¯
  anno_df$nearestGene <- rep("Unknown", nrow(anno_df))
  anno_df$geneId <- rep("Unknown", nrow(anno_df))
  anno_df$geneType <- rep("Unknown", nrow(anno_df))
  
  if(sum(valid_indices) > 0) {
    valid_genes <- genes_gr[nearest_indices[valid_indices]]
    
    # å®‰å…¨åœ°æå–åŸºå› ä¿¡æ¯
    if("gene_name" %in% colnames(mcols(valid_genes))) {
      anno_df$nearestGene[valid_indices] <- ifelse(
        is.na(valid_genes$gene_name), "Unknown", valid_genes$gene_name
      )
    }
    
    if("gene_id" %in% colnames(mcols(valid_genes))) {
      anno_df$geneId[valid_indices] <- ifelse(
        is.na(valid_genes$gene_id), "Unknown", valid_genes$gene_id
      )
    }
    
    if("gene_biotype" %in% colnames(mcols(valid_genes))) {
      anno_df$geneType[valid_indices] <- ifelse(
        is.na(valid_genes$gene_biotype), "Unknown", valid_genes$gene_biotype
      )
    }
  }
  
  # æ·»åŠ åŸºå› ç»„åŒºåŸŸåˆ†ç±»
  anno_df$annotation <- ifelse(
    is.na(anno_df$distanceToTSS), "Unknown",
    ifelse(abs(anno_df$distanceToTSS) <= 3000, "Promoter", 
           ifelse(abs(anno_df$distanceToTSS) <= 10000, "Proximal", "Distal"))
  )
  
  # ç»Ÿè®¡æ³¨é‡Šåˆ†å¸ƒ
  anno_stats <- table(anno_df$annotation)
  cat("\næ³¨é‡ŠåŒºåŸŸåˆ†å¸ƒ:\n")
  print(anno_stats)
  
  # åŸºå› ç±»å‹åˆ†å¸ƒ
  gene_type_stats <- table(anno_df$geneType)
  cat("\nåŸºå› ç±»å‹åˆ†å¸ƒï¼ˆå‰10ï¼‰:\n")
  print(head(sort(gene_type_stats, decreasing = TRUE), 10))
  
  # ä¿å­˜è¯¦ç»†æ³¨é‡Šç»“æœ
  write.csv(anno_df, file.path(output_dir, sprintf("ç»“æœ/%s_åŸºå› æ³¨é‡Šç»“æœ.csv", peak_type)), 
            row.names = FALSE)
  
  # ä¿å­˜ç»Ÿè®¡ç»“æœ
  write.csv(as.data.frame(anno_stats), 
            file.path(output_dir, sprintf("ç»“æœ/%s_åŒºåŸŸåˆ†å¸ƒç»Ÿè®¡.csv", peak_type)), 
            row.names = FALSE)
  
  write.csv(as.data.frame(gene_type_stats), 
            file.path(output_dir, sprintf("ç»“æœ/%s_åŸºå› ç±»å‹ç»Ÿè®¡.csv", peak_type)), 
            row.names = FALSE)
  
  # ä¿å­˜åŸºå› åˆ—è¡¨
  æœ‰æ•ˆåŸºå›  <- unique(anno_df$nearestGene[anno_df$nearestGene != "Unknown"])
  write.table(æœ‰æ•ˆåŸºå› , 
              file.path(output_dir, sprintf("åŸºå› åˆ—è¡¨/%s_æ³¨é‡ŠåŸºå› åˆ—è¡¨.txt", peak_type)), 
              row.names = FALSE, col.names = FALSE, quote = FALSE)
  
  cat("ä¿å­˜äº†", length(æœ‰æ•ˆåŸºå› ), "ä¸ªå”¯ä¸€åŸºå› åˆ°åŸºå› åˆ—è¡¨\n")
  
  # ç”Ÿæˆå›¾è¡¨
  tryCatch({
    # TSSè·ç¦»åˆ†å¸ƒå›¾
    valid_distances <- anno_df$distanceToTSS[!is.na(anno_df$distanceToTSS)]
    if(length(valid_distances) > 0) {
      pdf(file.path(output_dir, sprintf("å›¾è¡¨/%s_TSSè·ç¦»åˆ†å¸ƒå›¾.pdf", peak_type)), 
          width = 10, height = 6)
      hist(valid_distances, breaks = 50, 
           main = paste(peak_type, "å³°å€¼ç›¸å¯¹TSSè·ç¦»åˆ†å¸ƒ"),
           xlab = "è·ç¦»TSS (bp)", ylab = "å³°å€¼æ•°é‡",
           col = "lightblue", border = "black")
      abline(v = c(-3000, 3000), col = "red", lty = 2, lwd = 2)
      legend("topright", "å¯åŠ¨å­åŒºåŸŸ (Â±3kb)", col = "red", lty = 2, lwd = 2)
      dev.off()
    }
    
    # åŒºåŸŸåˆ†å¸ƒé¥¼å›¾
    if(length(anno_stats) > 0) {
      pdf(file.path(output_dir, sprintf("å›¾è¡¨/%s_åŒºåŸŸåˆ†å¸ƒé¥¼å›¾.pdf", peak_type)), 
          width = 8, height = 6)
      pie(anno_stats, main = paste(peak_type, "å³°å€¼åŸºå› ç»„åŒºåŸŸåˆ†å¸ƒ"),
          col = rainbow(length(anno_stats)))
      dev.off()
    }
    
    cat("âœ“ å›¾è¡¨ç”Ÿæˆå®Œæˆ\n")
    
  }, error = function(e) {
    cat("å›¾è¡¨ç”Ÿæˆæ—¶å‡ºç°è­¦å‘Š:", e$message, "\n")
  })
  
  cat("âœ“", peak_type, "åŸºå› æ³¨é‡Šå®Œæˆ\n")
  
  return(list(
    dataframe = anno_df,
    stats = anno_stats,
    gene_types = gene_type_stats,
    valid_genes = æœ‰æ•ˆåŸºå› 
  ))
}



# ä¿®æ­£é”™è¯¯å¹¶ç»§ç»­è¿›è¡Œæ³¨é‡Šåˆ†æ
cat("\n")
cat(paste(rep("=", 50), collapse=""))
cat("\n")
cat("å¼€å§‹åŸºå› æ³¨é‡Šåˆ†æ\n")
cat(paste(rep("=", 50), collapse=""))
cat("\n")

# æ³¨é‡Šå®½æ¾é˜ˆå€¼ç»“æœ
å®½æ¾_æ³¨é‡Šç»“æœ <- annotate_peaks_windows(edgeR_å®½æ¾, "EdgeR_å®½æ¾é˜ˆå€¼", genes_gr, è¾“å‡ºç›®å½•)

# æ³¨é‡Šä¸¥æ ¼é˜ˆå€¼ç»“æœï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
if(nrow(edgeR_ä¸¥æ ¼) > 0) {
  ä¸¥æ ¼_æ³¨é‡Šç»“æœ <- annotate_peaks_windows(edgeR_ä¸¥æ ¼, "EdgeR_ä¸¥æ ¼é˜ˆå€¼", genes_gr, è¾“å‡ºç›®å½•)
} else {
  ä¸¥æ ¼_æ³¨é‡Šç»“æœ <- NULL
  cat("\n! EdgeRä¸¥æ ¼é˜ˆå€¼ç»“æœä¸ºç©ºï¼Œè·³è¿‡æ³¨é‡Š\n")
}

# æ³¨é‡Šå®½æ¾é˜ˆå€¼ç»“æœ
å®½æ¾_æ³¨é‡Šç»“æœ <- annotate_peaks_windows(edgeR_å®½æ¾, "EdgeR_å®½æ¾é˜ˆå€¼", genes_gr, è¾“å‡ºç›®å½•)

# æ³¨é‡Šä¸¥æ ¼é˜ˆå€¼ç»“æœï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
if(nrow(edgeR_ä¸¥æ ¼) > 0) {
  ä¸¥æ ¼_æ³¨é‡Šç»“æœ <- annotate_peaks_windows(edgeR_ä¸¥æ ¼, "EdgeR_ä¸¥æ ¼é˜ˆå€¼", genes_gr, è¾“å‡ºç›®å½•)
} else {
  ä¸¥æ ¼_æ³¨é‡Šç»“æœ <- NULL
  cat("\n! EdgeRä¸¥æ ¼é˜ˆå€¼ç»“æœä¸ºç©ºï¼Œè·³è¿‡æ³¨é‡Š\n")
}

# ç”Ÿæˆç»¼åˆåˆ†ææŠ¥å‘Š
cat("\n=== ç”Ÿæˆç»¼åˆåˆ†ææŠ¥å‘Š ===\n")

# åˆ›å»ºç»¼åˆç»Ÿè®¡è¡¨
ç»¼åˆç»Ÿè®¡ <- data.frame()

if(!is.null(å®½æ¾_æ³¨é‡Šç»“æœ)) {
  å®½æ¾_è¡Œ <- data.frame(
    å³°å€¼ç±»å‹ = "EdgeR_å®½æ¾é˜ˆå€¼",
    å³°å€¼æ€»æ•° = nrow(edgeR_å®½æ¾),
    æ³¨é‡ŠæˆåŠŸæ•° = sum(!is.na(å®½æ¾_æ³¨é‡Šç»“æœ$dataframe$nearestGene) & 
                  å®½æ¾_æ³¨é‡Šç»“æœ$dataframe$nearestGene != "Unknown"),
    å”¯ä¸€åŸºå› æ•° = length(å®½æ¾_æ³¨é‡Šç»“æœ$valid_genes),
    å¯åŠ¨å­åŒºåŸŸ = sum(å®½æ¾_æ³¨é‡Šç»“æœ$dataframe$annotation == "Promoter", na.rm = TRUE),
    è¿‘ç«¯åŒºåŸŸ = sum(å®½æ¾_æ³¨é‡Šç»“æœ$dataframe$annotation == "Proximal", na.rm = TRUE),
    è¿œç«¯åŒºåŸŸ = sum(å®½æ¾_æ³¨é‡Šç»“æœ$dataframe$annotation == "Distal", na.rm = TRUE),
    å¹³å‡è·ç¦»TSS = round(mean(abs(å®½æ¾_æ³¨é‡Šç»“æœ$dataframe$distanceToTSS), na.rm = TRUE))
  )
  ç»¼åˆç»Ÿè®¡ <- rbind(ç»¼åˆç»Ÿè®¡, å®½æ¾_è¡Œ)
}

if(!is.null(ä¸¥æ ¼_æ³¨é‡Šç»“æœ)) {
  ä¸¥æ ¼_è¡Œ <- data.frame(
    å³°å€¼ç±»å‹ = "EdgeR_ä¸¥æ ¼é˜ˆå€¼",
    å³°å€¼æ€»æ•° = nrow(edgeR_ä¸¥æ ¼),
    æ³¨é‡ŠæˆåŠŸæ•° = sum(!is.na(ä¸¥æ ¼_æ³¨é‡Šç»“æœ$dataframe$nearestGene) & 
                  ä¸¥æ ¼_æ³¨é‡Šç»“æœ$dataframe$nearestGene != "Unknown"),
    å”¯ä¸€åŸºå› æ•° = length(ä¸¥æ ¼_æ³¨é‡Šç»“æœ$valid_genes),
    å¯åŠ¨å­åŒºåŸŸ = sum(ä¸¥æ ¼_æ³¨é‡Šç»“æœ$dataframe$annotation == "Promoter", na.rm = TRUE),
    è¿‘ç«¯åŒºåŸŸ = sum(ä¸¥æ ¼_æ³¨é‡Šç»“æœ$dataframe$annotation == "Proximal", na.rm = TRUE),
    è¿œç«¯åŒºåŸŸ = sum(ä¸¥æ ¼_æ³¨é‡Šç»“æœ$dataframe$annotation == "Distal", na.rm = TRUE),
    å¹³å‡è·ç¦»TSS = round(mean(abs(ä¸¥æ ¼_æ³¨é‡Šç»“æœ$dataframe$distanceToTSS), na.rm = TRUE))
  )
  ç»¼åˆç»Ÿè®¡ <- rbind(ç»¼åˆç»Ÿè®¡, ä¸¥æ ¼_è¡Œ)
}

if(nrow(ç»¼åˆç»Ÿè®¡) > 0) {
  write.csv(ç»¼åˆç»Ÿè®¡, file.path(è¾“å‡ºç›®å½•, "ç»“æœ/ç»¼åˆæ³¨é‡Šç»Ÿè®¡.csv"), row.names = FALSE)
  
  cat("=== ç»¼åˆæ³¨é‡Šç»Ÿè®¡ ===\n")
  print(ç»¼åˆç»Ÿè®¡)
}

# æå–å’Œå±•ç¤ºTopåŸºå› 
if(!is.null(ä¸¥æ ¼_æ³¨é‡Šç»“æœ) && nrow(ä¸¥æ ¼_æ³¨é‡Šç»“æœ$dataframe) > 0) {
  cat("\n=== ä¸¥æ ¼é˜ˆå€¼Top 20å…³é”®åŸºå›  ===\n")
  
  # æŒ‰fold changeæ’åº
  ä¸¥æ ¼_æœ‰æ•ˆ <- ä¸¥æ ¼_æ³¨é‡Šç»“æœ$dataframe[
    ä¸¥æ ¼_æ³¨é‡Šç»“æœ$dataframe$nearestGene != "Unknown" & 
      !is.na(ä¸¥æ ¼_æ³¨é‡Šç»“æœ$dataframe$nearestGene), ]
  
  if(nrow(ä¸¥æ ¼_æœ‰æ•ˆ) > 0) {
    ä¸¥æ ¼_æ’åº <- ä¸¥æ ¼_æœ‰æ•ˆ[order(abs(ä¸¥æ ¼_æœ‰æ•ˆ$fold_change), decreasing = TRUE), ]
    top20 <- head(ä¸¥æ ¼_æ’åº, 20)
    
    for(i in 1:nrow(top20)) {
      cat(sprintf("%2d. %-15s (FC=%6.2f, è·ç¦»TSS=%8d bp, %s)\n", 
                  i, 
                  top20$nearestGene[i], 
                  top20$fold_change[i], 
                  top20$distanceToTSS[i],
                  top20$annotation[i]))
    }
    
    # ä¿å­˜TopåŸºå› åˆ—è¡¨
    top_genes_file <- file.path(è¾“å‡ºç›®å½•, "ç»“æœ/ä¸¥æ ¼é˜ˆå€¼_Top20åŸºå› è¯¦ç»†.csv")
    write.csv(top20[, c("nearestGene", "geneId", "fold_change", "fdr", 
                        "distanceToTSS", "annotation", "geneType")], 
              top_genes_file, row.names = FALSE)
    
    cat("âœ“ Top 20åŸºå› è¯¦ç»†ä¿¡æ¯å·²ä¿å­˜åˆ°:", top_genes_file, "\n")
  }
}

# ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š
æŠ¥å‘Šæ–‡ä»¶ <- file.path(è¾“å‡ºç›®å½•, "åŸºå› æ³¨é‡Šåˆ†ææŠ¥å‘Š.txt")
æŠ¥å‘Šå†…å®¹ <- c(
  "=== ATAC-seqå·®å¼‚å³°åŸºå› æ³¨é‡Šåˆ†ææŠ¥å‘Š ===",
  paste("åˆ†ææ—¶é—´:", Sys.time()),
  paste("ç”¨æˆ·: buyu-ahau"),
  paste("å·¥ä½œç›®å½•:", getwd()),
  "",
  "=== è¾“å…¥æ–‡ä»¶ ===",
  paste("EdgeRå®½æ¾é˜ˆå€¼ç»“æœ:", edgeR_å®½æ¾_æ–‡ä»¶, "-", nrow(edgeR_å®½æ¾), "ä¸ªå³°å€¼"),
  paste("EdgeRä¸¥æ ¼é˜ˆå€¼ç»“æœ:", edgeR_ä¸¥æ ¼_æ–‡ä»¶, "-", nrow(edgeR_ä¸¥æ ¼), "ä¸ªå³°å€¼"),
  paste("çŒªåŸºå› ç»„GTFæ–‡ä»¶:", gtf_æ–‡ä»¶, "-", length(genes_gr), "ä¸ªåŸºå› "),
  "",
  "=== ä¸»è¦å‘ç° ===",
  if(nrow(ç»¼åˆç»Ÿè®¡) > 0) {
    apply(ç»¼åˆç»Ÿè®¡, 1, function(x) {
      paste(x["å³°å€¼ç±»å‹"], ":", x["å³°å€¼æ€»æ•°"], "ä¸ªå³°å€¼,", 
            x["å”¯ä¸€åŸºå› æ•°"], "ä¸ªåŸºå› ,", 
            x["å¯åŠ¨å­åŒºåŸŸ"], "ä¸ªå¯åŠ¨å­åŒºåŸŸ")
    })
  } else "æ— æœ‰æ•ˆç»“æœ",
  "",
  "=== ç”Ÿæˆæ–‡ä»¶ ===",
  "ç»“æœæ–‡ä»¶:",
  paste("- ", list.files(file.path(è¾“å‡ºç›®å½•, "ç»“æœ"), pattern = "\\.csv$")),
  "",
  "åŸºå› åˆ—è¡¨:",
  paste("- ", list.files(file.path(è¾“å‡ºç›®å½•, "åŸºå› åˆ—è¡¨"), pattern = "\\.txt$")),
  "",
  "å›¾è¡¨æ–‡ä»¶:",
  paste("- ", list.files(file.path(è¾“å‡ºç›®å½•, "å›¾è¡¨"), pattern = "\\.pdf$"))
)

writeLines(æŠ¥å‘Šå†…å®¹, æŠ¥å‘Šæ–‡ä»¶)

# ä¿å­˜å·¥ä½œç¯å¢ƒ
save.image(file.path(è¾“å‡ºç›®å½•, "åŸºå› æ³¨é‡Šåˆ†æ_Windowså®Œæ•´ç¯å¢ƒ.RData"))

# æœ€ç»ˆæ€»ç»“
cat("\n" + paste(rep("=", 60), collapse="") + "\n")
cat("ğŸ‰ Windowsç‰ˆåŸºå› æ³¨é‡Šåˆ†æå®Œæˆï¼\n")
cat(paste(rep("=", 60), collapse="") + "\n")
cat("å·¥ä½œç›®å½•:", getwd(), "\n")
cat("ç»“æœä¿å­˜åœ¨:", è¾“å‡ºç›®å½•, "\n")
cat("åˆ†æå®Œæˆæ—¶é—´:", as.character(Sys.time()), "\n")

if(nrow(ç»¼åˆç»Ÿè®¡) > 0) {
  cat("\nğŸ“Š æœ€ç»ˆç»Ÿè®¡:\n")
  print(ç»¼åˆç»Ÿè®¡)
}

cat("\nğŸ“ è¾“å‡ºæ–‡ä»¶å¤¹ç»“æ„:\n")
cat("ğŸ“‚", è¾“å‡ºç›®å½•, "\n")
cat("  â”œâ”€â”€ ğŸ“‚ ç»“æœ/ (CSVæ–‡ä»¶)\n")
cat("  â”œâ”€â”€ ğŸ“‚ å›¾è¡¨/ (PDFå›¾è¡¨)\n")
cat("  â”œâ”€â”€ ğŸ“‚ åŸºå› åˆ—è¡¨/ (åŸºå› åç§°æ–‡ä»¶)\n")
cat("  â”œâ”€â”€ ğŸ“„ åŸºå› æ³¨é‡Šåˆ†ææŠ¥å‘Š.txt\n")
cat("  â””â”€â”€ ğŸ“„ åŸºå› æ³¨é‡Šåˆ†æ_Windowså®Œæ•´ç¯å¢ƒ.RData\n")

cat("\nğŸ”¬ ä¸‹ä¸€æ­¥å»ºè®®:\n")
cat("1. æŸ¥çœ‹ 'ç»“æœ' æ–‡ä»¶å¤¹ä¸­çš„CSVæ–‡ä»¶\n")
cat("2. ä½¿ç”¨åŸºå› åˆ—è¡¨è¿›è¡Œåœ¨çº¿åŠŸèƒ½å¯Œé›†åˆ†æ\n")
cat("3. æŸ¥çœ‹PDFå›¾è¡¨äº†è§£åˆ†å¸ƒç‰¹å¾\n")
cat("4. é‡ç‚¹å…³æ³¨å¯åŠ¨å­åŒºåŸŸçš„å·®å¼‚å³°\n")

