


##sam转bam以后
# ATAC-seq数据上游分析    处理所有BAM文件
for bam in *.bam; do
    sambamba sort -t 32 -o "${bam%.bam}_sorted.bam" "$bam"
done

# 批量过滤所有sorted BAM文件
for bam in *_sorted.bam; do
    output_name="${bam/_sorted/_filtered}"
    echo "Processing $bam -> $output_name"
    sambamba view -h -t 64 -f bam -F "not unmapped and not duplicate and mapping_quality >= 30" "$bam" > "$output_name"
done

# 批量过滤所有sorted BAM文件
for bam in *_sorted.bam; do
    output_name="${bam/_sorted/_filtered}"
    echo "Processing $bam -> $output_name"
    sambamba view -h -t 64 -f bam -F "not unmapped and not duplicate and mapping_quality >= 30" "$bam" > "$output_name"
done


# 第一步：为所有filtered BAM文件生成索引
echo "Generating BAM indexes..."
for bam in *_filtered.bam; do
    echo "Indexing $bam"
    sambamba index -t 64 "$bam"
done

# 检查索引文件是否生成
ls -la *_filtered.bam.bai

# 第二步：重新运行染色体过滤
echo "Filtering chromosomes..."
for bam in *_filtered.bam; do
    output_name="${bam/_filtered/_final}"
    echo "Processing $bam -> $output_name"
    sambamba view -h -t 64 -f bam "$bam" 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 > "$output_name"
done




# 同时启动12个MACS2进程
for bam in ../../2.sorted_bam/03_final_bam/*_final.bam; do
    sample_name=$(basename "$bam" _final.bam)
    echo "Starting peak calling for $sample_name at $(date)"
    
    macs2 callpeak \
        -t "$bam" \
        -f BAMPE \
        -n "$sample_name" \
        -g 2.7e9 \
        --nomodel \
        --shift -75 \
        --extsize 150 \
        --keep-dup all \
        -q 0.01 \
        --outdir . &
done

# 等待所有进程完成
wait
echo "All peak calling jobs completed at $(date)"






echo "R脚本已创建"
