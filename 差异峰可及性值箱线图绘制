# ATAC-seqæŸ“è‰²è´¨å¯åŠæ€§å°æç´å›¾ç»˜åˆ¶
# ä½œè€…: buyu-ahau
# æ—¥æœŸ: 2025å¹´8æœˆ6æ—¥

ğŸ“‹ ç»Ÿè®¡ç»“æœ:
> cat("  â€¢ Ctrlç»„ä¸­ä½æ•°:", box_stats$Median[box_stats$Group == "Ctrl"], "\n")
  â€¢ Ctrlç»„ä¸­ä½æ•°: 8.01 
> cat("  â€¢ Mhpç»„ä¸­ä½æ•°:", box_stats$Median[box_stats$Group == "Mhp"], "\n")
  â€¢ Mhpç»„ä¸­ä½æ•°: 8.446 
> cat("  â€¢ ä¸­ä½æ•°å·®å¼‚:", 
+     round(box_stats$Median[box_stats$Group == "Mhp"] - box_stats$Median[box_stats$Group == "Ctrl"], 3), "\n")
  â€¢ ä¸­ä½æ•°å·®å¼‚: 0.436 
> cat("  â€¢ ç»Ÿè®¡æ˜¾è‘—æ€§:", significance, "\n")
  â€¢ ç»Ÿè®¡æ˜¾è‘—æ€§: *** 


  
cat("=== ATAC-seqæŸ“è‰²è´¨å¯åŠæ€§å°æç´å›¾ç»˜åˆ¶ ===\n")
cat("åˆ†ææ—¶é—´:", as.character(Sys.time()), "\n")
cat("ç”¨æˆ·: buyu-ahau\n\n")

# åŠ è½½å¿…éœ€çš„åŒ…
required_packages <- c("ggplot2", "dplyr", "tidyr", "ggbeeswarm", "viridis")

for(pkg in required_packages) {
  if (!requireNamespace(pkg, quietly = TRUE)) {
    cat("æ­£åœ¨å®‰è£…åŒ…:", pkg, "\n")
    install.packages(pkg)
  }
}

library(ggplot2)
library(dplyr)
library(tidyr)
library(ggbeeswarm)
library(viridis)

# åˆ›å»ºè¾“å‡ºç›®å½•
è¾“å‡ºç›®å½• <- "åŸºå› æ³¨é‡Šåˆ†æç»“æœ"
å°æç´å›¾ç›®å½• <- file.path(è¾“å‡ºç›®å½•, "å°æç´å›¾åˆ†æ")
dir.create(å°æç´å›¾ç›®å½•, showWarnings = FALSE)

# è¯»å–æ•°æ®ï¼ˆå¦‚æœè¿˜æ²¡æœ‰åŠ è½½çš„è¯ï¼‰
if(!exists("edgeR_å®½æ¾_data")) {
  edgeR_å®½æ¾_data <- read.csv("EdgeR_å®½æ¾é˜ˆå€¼_æ˜¾è‘—åŒºåŸŸ.csv", header = TRUE)
}

cat("=== æ•°æ®å‡†å¤‡ ===\n")
cat("å·®å¼‚peaksæ€»æ•°:", nrow(edgeR_å®½æ¾_data), "\n")
cat("Ctrlç»„æµ“åº¦èŒƒå›´:", round(range(edgeR_å®½æ¾_data$Conc_Control), 2), "\n")
cat("Mhpç»„æµ“åº¦èŒƒå›´:", round(range(edgeR_å®½æ¾_data$Conc_Experimental), 2), "\n")

# å°†æ•°æ®è½¬æ¢ä¸ºé•¿æ ¼å¼ç”¨äºggplot2
cat("\næ­£åœ¨å‡†å¤‡å°æç´å›¾æ•°æ®...\n")

violin_data <- data.frame(
  Peak_ID = rep(paste0("Peak_", 1:nrow(edgeR_å®½æ¾_data)), 2),
  Group = rep(c("Ctrl", "Mhp"), each = nrow(edgeR_å®½æ¾_data)),
  Accessibility = c(edgeR_å®½æ¾_data$Conc_Control, edgeR_å®½æ¾_data$Conc_Experimental),
  Fold_Change = rep(edgeR_å®½æ¾_data$Fold, 2),
  FDR = rep(edgeR_å®½æ¾_data$FDR, 2),
  stringsAsFactors = FALSE
)

# æ·»åŠ up/downè°ƒæ§ä¿¡æ¯
violin_data$Regulation <- ifelse(violin_data$Fold_Change > 0, "Up", "Down")

cat("âœ“ æ•°æ®å‡†å¤‡å®Œæˆ\n")
cat("å°æç´å›¾æ•°æ®ç‚¹æ•°:", nrow(violin_data), "\n")
cat("Ctrlç»„æ•°æ®ç‚¹:", sum(violin_data$Group == "Ctrl"), "\n")
cat("Mhpç»„æ•°æ®ç‚¹:", sum(violin_data$Group == "Mhp"), "\n")

# åŸºæœ¬ç»Ÿè®¡
cat("\n=== åŸºæœ¬ç»Ÿè®¡ ===\n")
group_stats <- violin_data %>%
  group_by(Group) %>%
  summarise(
    Mean = round(mean(Accessibility), 3),
    Median = round(median(Accessibility), 3),
    SD = round(sd(Accessibility), 3),
    Min = round(min(Accessibility), 3),
    Max = round(max(Accessibility), 3),
    .groups = 'drop'
  )

print(group_stats)

cat("\n=== å¼€å§‹ç»˜åˆ¶å°æç´å›¾ ===\n")

# 1. åŸºç¡€å°æç´å›¾
cat("1. ç”ŸæˆåŸºç¡€å°æç´å›¾...\n")

p1 <- ggplot(violin_data, aes(x = Group, y = Accessibility, fill = Group)) +
  geom_violin(alpha = 0.7, trim = FALSE) +
  geom_boxplot(width = 0.1, alpha = 0.8, outlier.shape = NA) +
  geom_jitter(width = 0.2, alpha = 0.3, size = 0.5) +
  scale_fill_manual(values = c("Ctrl" = "#3498db", "Mhp" = "#e74c3c")) +
  labs(
    title = "ATAC-seqæŸ“è‰²è´¨å¯åŠæ€§åˆ†å¸ƒæ¯”è¾ƒ",
    subtitle = paste("åŸºäº", nrow(edgeR_å®½æ¾_data), "ä¸ªå·®å¼‚peaks (FDR < 0.05)"),
    x = "å®éªŒç»„åˆ«",
    y = "æŸ“è‰²è´¨å¯åŠæ€§ (Log2 æ ‡å‡†åŒ–æµ“åº¦)",
    fill = "ç»„åˆ«"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5, size = 12),
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 11),
    legend.position = "none"
  ) +
  stat_summary(fun = mean, geom = "point", shape = 23, size = 3, 
               fill = "white", color = "black")

# ä¿å­˜åŸºç¡€å°æç´å›¾
ggsave(file.path(å°æç´å›¾ç›®å½•, "åŸºç¡€å°æç´å›¾.pdf"), p1, 
       width = 8, height = 6, dpi = 300)

# 2. èœ‚ç¾¤å›¾ç‰ˆæœ¬ (æ›´æ¸…æ¥šåœ°æ˜¾ç¤ºæ¯ä¸ªç‚¹)
cat("2. ç”Ÿæˆèœ‚ç¾¤å›¾ç‰ˆæœ¬...\n")

p2 <- ggplot(violin_data, aes(x = Group, y = Accessibility, color = Group)) +
  geom_violin(aes(fill = Group), alpha = 0.3, trim = FALSE) +
  geom_quasirandom(alpha = 0.6, size = 0.8) +
  geom_boxplot(width = 0.1, alpha = 0.8, outlier.shape = NA, 
               color = "black", fill = "white") +
  scale_fill_manual(values = c("Ctrl" = "#3498db", "Mhp" = "#e74c3c")) +
  scale_color_manual(values = c("Ctrl" = "#2980b9", "Mhp" = "#c0392b")) +
  labs(
    title = "ATAC-seqæŸ“è‰²è´¨å¯åŠæ€§åˆ†å¸ƒ - èœ‚ç¾¤å›¾",
    subtitle = paste("æ¯ä¸ªç‚¹ä»£è¡¨ä¸€ä¸ªå·®å¼‚peak,", "å…±", nrow(edgeR_å®½æ¾_data), "ä¸ªpeaks"),
    x = "å®éªŒç»„åˆ«", 
    y = "æŸ“è‰²è´¨å¯åŠæ€§ (Log2 æ ‡å‡†åŒ–æµ“åº¦)",
    fill = "ç»„åˆ«",
    color = "ç»„åˆ«"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5, size = 12),
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 11),
    legend.position = "none"
  ) +
  stat_summary(fun = mean, geom = "point", shape = 23, size = 4, 
               fill = "yellow", color = "black")

ggsave(file.path(å°æç´å›¾ç›®å½•, "èœ‚ç¾¤å›¾ç‰ˆæœ¬.pdf"), p2, 
       width = 8, height = 6, dpi = 300)

# ä¿®å¤ç¬¬3ä¸ªå›¾è¡¨çš„é”™è¯¯å¹¶ç»§ç»­å®Œæˆåˆ†æ

cat("3. ä¿®å¤å¹¶é‡æ–°ç”ŸæˆæŒ‰è°ƒæ§æ–¹å‘åˆ†å±‚çš„å°æç´å›¾...\n")

p3 <- ggplot(violin_data, aes(x = Group, y = Accessibility, fill = Regulation)) +
  geom_violin(alpha = 0.7, position = position_dodge(0.8)) +
  geom_boxplot(width = 0.1, alpha = 0.8, outlier.shape = NA,
               position = position_dodge(0.8)) +
  # ä¿®å¤ï¼šç§»é™¤widthå‚æ•°ï¼Œåªä½¿ç”¨position
  geom_jitter(aes(color = Regulation), alpha = 0.4, size = 0.6,
              position = position_jitterdodge(dodge.width = 0.8, jitter.width = 0.15)) +
  scale_fill_manual(values = c("Up" = "#e74c3c", "Down" = "#3498db")) +
  scale_color_manual(values = c("Up" = "#c0392b", "Down" = "#2980b9")) +
  labs(
    title = "ATAC-seqæŸ“è‰²è´¨å¯åŠæ€§åˆ†å¸ƒ - æŒ‰è°ƒæ§æ–¹å‘åˆ†å±‚",
    subtitle = "çº¢è‰²: ä¸Šè°ƒpeaks, è“è‰²: ä¸‹è°ƒpeaks",
    x = "å®éªŒç»„åˆ«",
    y = "æŸ“è‰²è´¨å¯åŠæ€§ (Log2 æ ‡å‡†åŒ–æµ“åº¦)",
    fill = "è°ƒæ§æ–¹å‘",
    color = "è°ƒæ§æ–¹å‘"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5, size = 12),
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 11),
    legend.position = "right"
  )

ggsave(file.path(å°æç´å›¾ç›®å½•, "è°ƒæ§æ–¹å‘åˆ†å±‚å°æç´å›¾.pdf"), p3, 
       width = 10, height = 6, dpi = 300)

cat("âœ“ è°ƒæ§æ–¹å‘åˆ†å±‚å°æç´å›¾å®Œæˆ\n")

# 4. å¯¹æ¯”ç»Ÿè®¡åˆ†æ
cat("4. è¿›è¡Œç»Ÿè®¡æ£€éªŒ...\n")

# tæ£€éªŒ
t_test_result <- t.test(Accessibility ~ Group, data = violin_data)
wilcox_test_result <- wilcox.test(Accessibility ~ Group, data = violin_data)

cat("\n=== ç»Ÿè®¡æ£€éªŒç»“æœ ===\n")
cat("tæ£€éªŒ på€¼:", format(t_test_result$p.value, scientific = TRUE), "\n")
cat("Wilcoxonæ£€éªŒ på€¼:", format(wilcox_test_result$p.value, scientific = TRUE), "\n")
cat("Ctrlç»„å‡å€¼:", round(t_test_result$estimate[1], 3), "\n")
cat("Mhpç»„å‡å€¼:", round(t_test_result$estimate[2], 3), "\n")
cat("å‡å€¼å·®å¼‚:", round(t_test_result$estimate[2] - t_test_result$estimate[1], 3), "\n")

# æ•ˆåº”é‡è®¡ç®— (Cohen's d)
pooled_sd <- sqrt(((sum(violin_data$Group == "Ctrl") - 1) * var(violin_data$Accessibility[violin_data$Group == "Ctrl"]) + 
                     (sum(violin_data$Group == "Mhp") - 1) * var(violin_data$Accessibility[violin_data$Group == "Mhp"])) / 
                    (nrow(violin_data) - 2))

cohens_d <- (t_test_result$estimate[2] - t_test_result$estimate[1]) / pooled_sd
cat("Cohen's d (æ•ˆåº”é‡):", round(cohens_d, 3), "\n")

# 5. å¸¦ç»Ÿè®¡æ ‡æ³¨çš„å°æç´å›¾
cat("5. ç”Ÿæˆå¸¦ç»Ÿè®¡æ ‡æ³¨çš„å°æç´å›¾...\n")

# è®¡ç®—ç»Ÿè®¡æ˜¾è‘—æ€§æ ‡æ³¨
p_value <- t_test_result$p.value
significance <- if(p_value < 0.001) "***" else if(p_value < 0.01) "**" else if(p_value < 0.05) "*" else "ns"

p4 <- ggplot(violin_data, aes(x = Group, y = Accessibility, fill = Group)) +
  geom_violin(alpha = 0.7, trim = FALSE) +
  geom_boxplot(width = 0.1, alpha = 0.8, outlier.shape = NA) +
  geom_jitter(width = 0.2, alpha = 0.2, size = 0.5) +
  scale_fill_manual(values = c("Ctrl" = "#3498db", "Mhp" = "#e74c3c")) +
  labs(
    title = "ATAC-seqæŸ“è‰²è´¨å¯åŠæ€§ç»„é—´æ¯”è¾ƒ",
    subtitle = paste("å·®å¼‚peaks:", nrow(edgeR_å®½æ¾_data), "ä¸ª | p =", 
                     format(p_value, scientific = TRUE, digits = 3), "| Cohen's d =", round(cohens_d, 3)),
    x = "å®éªŒç»„åˆ«",
    y = "æŸ“è‰²è´¨å¯åŠæ€§ (Log2 æ ‡å‡†åŒ–æµ“åº¦)",
    fill = "ç»„åˆ«"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5, size = 12),
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 11),
    legend.position = "none"
  ) +
  stat_summary(fun = mean, geom = "point", shape = 23, size = 3, 
               fill = "white", color = "black") +
  # æ·»åŠ ç»Ÿè®¡æ ‡æ³¨
  annotate("text", x = 1.5, y = max(violin_data$Accessibility) * 0.95, 
           label = significance, size = 6, fontface = "bold") +
  annotate("segment", x = 1, xend = 2, 
           y = max(violin_data$Accessibility) * 0.92, 
           yend = max(violin_data$Accessibility) * 0.92)

ggsave(file.path(å°æç´å›¾ç›®å½•, "ç»Ÿè®¡æ ‡æ³¨å°æç´å›¾.pdf"), p4, 
       width = 8, height = 6, dpi = 300)

cat("âœ“ ç»Ÿè®¡æ ‡æ³¨å°æç´å›¾å®Œæˆ\n")

# 6. åˆ†ç»„ç»Ÿè®¡è¯¦ç»†åˆ†æ
cat("6. è¿›è¡Œåˆ†ç»„ç»Ÿè®¡åˆ†æ...\n")

# æŒ‰è°ƒæ§æ–¹å‘ç»Ÿè®¡
regulation_stats <- violin_data %>%
  group_by(Group, Regulation) %>%
  summarise(
    Count = n(),
    Mean = round(mean(Accessibility), 3),
    Median = round(median(Accessibility), 3),
    SD = round(sd(Accessibility), 3),
    .groups = 'drop'
  )

cat("\n=== æŒ‰è°ƒæ§æ–¹å‘çš„ç»Ÿè®¡ ===\n")
print(regulation_stats)

# ä¸Šè°ƒå’Œä¸‹è°ƒå³°å€¼çš„æ•°é‡ç»Ÿè®¡
up_down_counts <- violin_data %>%
  filter(Group == "Ctrl") %>%  # åªéœ€è¦è®¡ç®—ä¸€æ¬¡ï¼Œå› ä¸ºRegulationå¯¹ä¸¤ç»„éƒ½ä¸€æ ·
  group_by(Regulation) %>%
  summarise(Count = n(), .groups = 'drop')

cat("\n=== ä¸Šè°ƒä¸‹è°ƒå³°å€¼æ•°é‡ ===\n")
print(up_down_counts)

# ä¿å­˜ç»Ÿè®¡ç»“æœ
ç»Ÿè®¡ç»“æœ <- data.frame(
  æ£€éªŒæ–¹æ³• = c("tæ£€éªŒ", "Wilcoxonæ£€éªŒ"),
  på€¼ = c(t_test_result$p.value, wilcox_test_result$p.value),
  ç»Ÿè®¡é‡ = c(t_test_result$statistic, wilcox_test_result$statistic),
  æ˜¾è‘—æ€§ = c(significance, if(wilcox_test_result$p.value < 0.05) "æ˜¾è‘—" else "ä¸æ˜¾è‘—"),
  Cohens_d = c(cohens_d, NA)
)

write.csv(ç»Ÿè®¡ç»“æœ, file.path(å°æç´å›¾ç›®å½•, "ç»Ÿè®¡æ£€éªŒç»“æœ.csv"), row.names = FALSE)
write.csv(group_stats, file.path(å°æç´å›¾ç›®å½•, "ç»„é—´ç»Ÿè®¡æè¿°.csv"), row.names = FALSE)
write.csv(regulation_stats, file.path(å°æç´å›¾ç›®å½•, "è°ƒæ§æ–¹å‘ç»Ÿè®¡.csv"), row.names = FALSE)

# ä¿å­˜å·¥ä½œç¯å¢ƒ
save.image(file.path(å°æç´å›¾ç›®å½•, "å°æç´å›¾åˆ†æç¯å¢ƒ.RData"))

# æœ€ç»ˆæ€»ç»“
cat("\n")
cat(paste(rep("=", 70), collapse=""))
cat("\n")
cat("ğŸ» ATAC-seqå°æç´å›¾ç»˜åˆ¶å®Œæˆï¼\n")
cat(paste(rep("=", 70), collapse=""))
cat("\n")

cat("ğŸ“Š å…³é”®æ•°æ®å‘ç°:\n")
cat("  â€¢ å·®å¼‚peaksæ•°é‡:", nrow(edgeR_å®½æ¾_data), "\n")
cat("  â€¢ Ctrlç»„å¹³å‡å¯åŠæ€§:", round(group_stats$Mean[group_stats$Group == "Ctrl"], 3), "\n")
cat("  â€¢ Mhpç»„å¹³å‡å¯åŠæ€§:", round(group_stats$Mean[group_stats$Group == "Mhp"], 3), "\n")
cat("  â€¢ ç»„é—´å·®å¼‚æ˜¾è‘—æ€§:", significance, "\n")
cat("  â€¢ æ•ˆåº”é‡ (Cohen's d):", round(cohens_d, 3), "\n")
cat("  â€¢ ä¸Šè°ƒpeaks:", up_down_counts$Count[up_down_counts$Regulation == "Up"], "ä¸ª\n")
cat("  â€¢ ä¸‹è°ƒpeaks:", up_down_counts$Count[up_down_counts$Regulation == "Down"], "ä¸ª\n")

cat("\nğŸ“ ç”Ÿæˆçš„å›¾è¡¨æ–‡ä»¶:\n")
cat("  âœ“ åŸºç¡€å°æç´å›¾.pdf\n")
cat("  âœ“ èœ‚ç¾¤å›¾ç‰ˆæœ¬.pdf (æ¯ä¸ªç‚¹æ›´æ¸…æ¥š)\n")
cat("  âœ“ è°ƒæ§æ–¹å‘åˆ†å±‚å°æç´å›¾.pdf (ä¿®å¤ç‰ˆ)\n")
cat("  âœ“ ç»Ÿè®¡æ ‡æ³¨å°æç´å›¾.pdf\n")

cat("\nğŸ“‹ æ•°æ®æ–‡ä»¶:\n")
cat("  âœ“ ç»Ÿè®¡æ£€éªŒç»“æœ.csv\n")
cat("  âœ“ ç»„é—´ç»Ÿè®¡æè¿°.csv\n")
cat("  âœ“ è°ƒæ§æ–¹å‘ç»Ÿè®¡.csv\n")

cat("\nğŸ¯ ç”Ÿç‰©å­¦æ„ä¹‰:\n")
cat("  â€¢ Mhpç»„æ•´ä½“æŸ“è‰²è´¨å¯åŠæ€§æ˜¾è‘—é«˜äºCtrlç»„\n")
cat("  â€¢ å¹³å‡å·®å¼‚:", round(group_stats$Mean[group_stats$Group == "Mhp"] - group_stats$Mean[group_stats$Group == "Ctrl"], 3), "log2å•ä½\n")
cat("  â€¢ è¿™è¡¨æ˜Mhpæ„ŸæŸ“å¢åŠ äº†æŸ“è‰²è´¨çš„æ•´ä½“å¼€æ”¾æ€§\n")

cat("\nåˆ†æå®Œæˆæ—¶é—´:", as.character(Sys.time()), "\n")


# åˆ é™¤å‡å€¼æ ‡è®°çš„å¹²å‡€ç®±çº¿å›¾
# ä½œè€…: buyu-ahau
# æ—¥æœŸ: 2025å¹´8æœˆ6æ—¥

cat("=== ç»˜åˆ¶æ— å‡å€¼æ ‡è®°çš„å¹²å‡€ç®±çº¿å›¾ ===\n")

# åˆ›å»ºå¹²å‡€ç‰ˆæœ¬ç›®å½•
clean_dir <- file.path(boxplot_dir, "å¹²å‡€ç‰ˆæœ¬")
dir.create(clean_dir, showWarnings = FALSE)

# Natureé…è‰²
nature_colors <- c("Ctrl" = "#4472C4", "Mhp" = "#E15759")

# 1. å¹²å‡€çš„ç»å…¸ç®±çº¿å›¾ï¼ˆåˆ é™¤å‡å€¼æ ‡è®°ï¼‰
cat("1. ç”Ÿæˆå¹²å‡€çš„ç»å…¸ç®±çº¿å›¾...\n")

clean_nature_boxplot <- ggplot(violin_data, aes(x = Group, y = Accessibility, fill = Group)) +
  # ä¸»ç®±çº¿å›¾ï¼ˆåˆ é™¤å‡å€¼æ ‡è®°ï¼‰
  geom_boxplot(alpha = 0.8, size = 0.8, color = "black", width = 0.6,
               outlier.shape = 21, outlier.size = 1.5, outlier.alpha = 0.6,
               outlier.fill = "white", outlier.color = "black") +
  
  # ï¼ï¼ï¼åˆ é™¤è¿™è¡Œå°±æ²¡æœ‰ç™½è‰²è±å½¢äº†ï¼ï¼ï¼
  # stat_summary(fun = mean, geom = "point", shape = 23, size = 4, 
  #              fill = "white", color = "black", stroke = 1.2) +
  
  scale_fill_manual(values = nature_colors) +
  scale_y_continuous(
    name = "Chromatin accessibility\n(Logâ‚‚ normalized concentration)",
    breaks = pretty_breaks(n = 6),
    expand = expansion(mult = c(0.02, 0.1))
  ) +
  scale_x_discrete(name = "") +
  
  theme_classic() +
  theme(
    plot.background = element_rect(fill = "white", color = NA),
    panel.background = element_rect(fill = "white", color = NA),
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold", 
                              color = "black", margin = margin(b = 20)),
    plot.subtitle = element_text(hjust = 0.5, size = 11, color = "black",
                                 margin = margin(b = 15)),
    axis.title.y = element_text(size = 12, color = "black", face = "bold"),
    axis.text = element_text(size = 11, color = "black"),
    axis.text.x = element_text(size = 12, color = "black", face = "bold"),
    axis.line = element_line(color = "black", size = 0.8),
    axis.ticks = element_line(color = "black", size = 0.6),
    axis.ticks.length = unit(0.2, "cm"),
    panel.grid = element_blank(),
    legend.position = "none",
    plot.margin = margin(20, 20, 20, 20)
  ) +
  
  labs(
    title = "ATAC-seq differential chromatin accessibility",
    subtitle = paste0("n = ", nrow(edgeR_å®½æ¾_data), " peaks")
  ) +
  
  # ç»Ÿè®¡æ ‡æ³¨
  annotate("segment", x = 1, xend = 2, 
           y = max_y + y_range * 0.05, yend = max_y + y_range * 0.05,
           color = "black", size = 0.8) +
  annotate("segment", x = 1, xend = 1, 
           y = max_y + y_range * 0.05, yend = max_y + y_range * 0.02,
           color = "black", size = 0.8) +
  annotate("segment", x = 2, xend = 2, 
           y = max_y + y_range * 0.05, yend = max_y + y_range * 0.02,
           color = "black", size = 0.8) +
  annotate("text", x = 1.5, y = max_y + y_range * 0.08, 
           label = significance, size = 5, fontface = "bold") +
  annotate("text", x = 1.5, y = max_y + y_range * 0.12, 
           label = paste0("p = ", format(p_value, scientific = TRUE, digits = 2)),
           size = 3.5, color = "black")

# ä¿å­˜å¹²å‡€ç‰ˆæœ¬
ggsave(file.path(clean_dir, "å¹²å‡€ç®±çº¿å›¾_æ— å‡å€¼æ ‡è®°.pdf"), 
       clean_nature_boxplot, width = 4.5, height = 5.5, dpi = 600)

ggsave(file.path(clean_dir, "å¹²å‡€ç®±çº¿å›¾_æ— å‡å€¼æ ‡è®°.png"), 
       clean_nature_boxplot, width = 4.5, height = 5.5, dpi = 300, bg = "white")

# 2. å®Œå…¨å¹²å‡€ç‰ˆæœ¬ï¼ˆè¿å¼‚å¸¸å€¼éƒ½ä¸æ˜¾ç¤ºï¼‰
cat("2. ç”Ÿæˆå®Œå…¨å¹²å‡€ç‰ˆæœ¬...\n")

ultra_clean_boxplot <- ggplot(violin_data, aes(x = Group, y = Accessibility, fill = Group)) +
  # ç®±çº¿å›¾ï¼Œä¸æ˜¾ç¤ºå¼‚å¸¸å€¼å’Œå‡å€¼
  geom_boxplot(alpha = 0.8, size = 0.8, color = "black", width = 0.6,
               outlier.shape = NA) +  # ä¸æ˜¾ç¤ºå¼‚å¸¸å€¼
  
  scale_fill_manual(values = nature_colors) +
  scale_y_continuous(
    name = "Chromatin accessibility\n(Logâ‚‚ normalized concentration)",
    breaks = pretty_breaks(n = 6),
    expand = expansion(mult = c(0.02, 0.08))
  ) +
  scale_x_discrete(name = "") +
  
  theme_classic() +
  theme(
    plot.background = element_rect(fill = "white", color = NA),
    panel.background = element_rect(fill = "white", color = NA),
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold", color = "black"),
    axis.title.y = element_text(size = 12, color = "black", face = "bold"),
    axis.text = element_text(size = 11, color = "black"),
    axis.text.x = element_text(size = 12, color = "black", face = "bold"),
    axis.line = element_line(color = "black", size = 0.8),
    axis.ticks = element_line(color = "black", size = 0.6),
    panel.grid = element_blank(),
    legend.position = "none",
    plot.margin = margin(20, 20, 20, 20)
  ) +
  
  labs(title = "ATAC-seq chromatin accessibility") +
  
  # ç»Ÿè®¡æ ‡æ³¨
  annotate("segment", x = 1, xend = 2, 
           y = max_y + y_range * 0.02, yend = max_y + y_range * 0.02,
           color = "black", size = 0.8) +
  annotate("text", x = 1.5, y = max_y + y_range * 0.04, 
           label = significance, size = 5, fontface = "bold")

ggsave(file.path(clean_dir, "å®Œå…¨å¹²å‡€ç®±çº¿å›¾.pdf"), 
       ultra_clean_boxplot, width = 4.5, height = 5, dpi = 600)

# 3. ç®€çº¦ç‰ˆæœ¬ï¼ˆé€‚åˆæœŸåˆŠï¼‰
cat("3. ç”ŸæˆæœŸåˆŠç®€çº¦ç‰ˆæœ¬...\n")

journal_boxplot <- ggplot(violin_data, aes(x = Group, y = Accessibility, fill = Group)) +
  geom_boxplot(alpha = 0.7, size = 0.6, color = "black", width = 0.5,
               outlier.shape = 16, outlier.size = 0.8, outlier.alpha = 0.5) +
  
  scale_fill_manual(values = nature_colors) +
  scale_y_continuous(
    name = "Chromatin accessibility",
    breaks = pretty_breaks(n = 5)
  ) +
  scale_x_discrete(name = "") +
  
  theme_classic() +
  theme(
    plot.background = element_rect(fill = "white", color = NA),
    panel.background = element_rect(fill = "white", color = NA),
    axis.title.y = element_text(size = 11, color = "black"),
    axis.text = element_text(size = 10, color = "black"),
    axis.text.x = element_text(size = 11, color = "black", face = "bold"),
    axis.line = element_line(color = "black", size = 0.7),
    axis.ticks = element_line(color = "black", size = 0.5),
    panel.grid = element_blank(),
    legend.position = "none",
    plot.margin = margin(15, 15, 15, 15)
  ) +
  
  # ç®€å•ç»Ÿè®¡æ ‡æ³¨
  annotate("text", x = 1.5, y = max_y + y_range * 0.03, 
           label = significance, size = 4, fontface = "bold")

ggsave(file.path(clean_dir, "æœŸåˆŠç®€çº¦ç‰ˆç®±çº¿å›¾.pdf"), 
       journal_boxplot, width = 3.5, height = 4, dpi = 600)

# 4. å½©è‰²è¾¹æ¡†ç‰ˆæœ¬
cat("4. ç”Ÿæˆå½©è‰²è¾¹æ¡†ç‰ˆæœ¬...\n")

colored_border_boxplot <- ggplot(violin_data, aes(x = Group, y = Accessibility, fill = Group, color = Group)) +
  geom_boxplot(alpha = 0.6, size = 1.2, width = 0.6,
               outlier.shape = 16, outlier.size = 1, outlier.alpha = 0.6) +
  
  scale_fill_manual(values = nature_colors) +
  scale_color_manual(values = c("Ctrl" = "#2E5090", "Mhp" = "#B8312F")) +  # æ·±è‰²è¾¹æ¡†
  
  scale_y_continuous(
    name = "Chromatin accessibility\n(Logâ‚‚ normalized concentration)",
    breaks = pretty_breaks(n = 6)
  ) +
  scale_x_discrete(name = "") +
  
  theme_classic() +
  theme(
    plot.background = element_rect(fill = "white", color = NA),
    panel.background = element_rect(fill = "white", color = NA),
    axis.title.y = element_text(size = 12, color = "black", face = "bold"),
    axis.text = element_text(size = 11, color = "black"),
    axis.text.x = element_text(size = 12, color = "black", face = "bold"),
    axis.line = element_line(color = "black", size = 0.8),
    axis.ticks = element_line(color = "black", size = 0.6),
    panel.grid = element_blank(),
    legend.position = "none",
    plot.margin = margin(20, 20, 20, 20)
  )

ggsave(file.path(clean_dir, "å½©è‰²è¾¹æ¡†ç®±çº¿å›¾.pdf"), 
       colored_border_boxplot, width = 4.5, height = 5, dpi = 600)

cat("\n")
cat(paste(rep("=", 60), collapse=""))
cat("\n")
cat("âœ¨ å¹²å‡€ç‰ˆç®±çº¿å›¾åˆ¶ä½œå®Œæˆï¼\n")
cat(paste(rep("=", 60), collapse=""))
cat("\n")

cat("ğŸ“ å¹²å‡€ç‰ˆæœ¬ä¿å­˜ä½ç½®:\n")
cat("  ", clean_dir, "\n")

cat("\nğŸ“Š ç”Ÿæˆçš„å¹²å‡€ç‰ˆæœ¬:\n")
cat("  âœ“ å¹²å‡€ç®±çº¿å›¾_æ— å‡å€¼æ ‡è®°.pdf (åˆ é™¤ç™½è‰²è±å½¢)\n")
cat("  âœ“ å®Œå…¨å¹²å‡€ç®±çº¿å›¾.pdf (è¿å¼‚å¸¸å€¼éƒ½åˆ é™¤)\n")
cat("  âœ“ æœŸåˆŠç®€çº¦ç‰ˆç®±çº¿å›¾.pdf (ç®€çº¦æœŸåˆŠé£æ ¼)\n")
cat("  âœ“ å½©è‰²è¾¹æ¡†ç®±çº¿å›¾.pdf (å½©è‰²è¾¹æ¡†ç‰ˆ)\n")

cat("\nğŸ¯ åˆ é™¤çš„å…ƒç´ :\n")
cat("  âŒ ç™½è‰²è±å½¢å‡å€¼æ ‡è®° (å½±å“ç¾è§‚)\n")
cat("  âŒ éƒ¨åˆ†ç‰ˆæœ¬åˆ é™¤å¼‚å¸¸å€¼ç‚¹\n")
cat("  âœ… ä¿ç•™ç®±çº¿å›¾æ ¸å¿ƒä¿¡æ¯\n")
cat("  âœ… ä¿ç•™ç»Ÿè®¡æ˜¾è‘—æ€§æ ‡æ³¨\n")

cat("\nğŸ’¡ æ¨èä½¿ç”¨:\n")
cat("  â€¢ æœŸåˆŠæŠ•ç¨¿: å¹²å‡€ç®±çº¿å›¾_æ— å‡å€¼æ ‡è®°.pdf\n")
cat("  â€¢ æ¼”ç¤ºæŠ¥å‘Š: å®Œå…¨å¹²å‡€ç®±çº¿å›¾.pdf\n")
cat("  â€¢ ç»„åˆå›¾: æœŸåˆŠç®€çº¦ç‰ˆç®±çº¿å›¾.pdf\n")

cat("\nåˆ†æå®Œæˆæ—¶é—´:", as.character(Sys.time()), "\n")

