# åŠ è½½åŒ…
library(ChIPseeker)
library(GenomicFeatures)
library(ggplot2)

# åˆ›å»ºè¾“å‡ºç›®å½•
chipseeker_dir <- file.path(è¾“å‡ºç›®å½•, "ChIPseekeræ ‡å‡†æ³¨é‡Š")
dir.create(chipseeker_dir, showWarnings = FALSE)
dir.create(file.path(chipseeker_dir, "å›¾è¡¨"), showWarnings = FALSE)
dir.create(file.path(chipseeker_dir, "æ•°æ®"), showWarnings = FALSE)

cat("\n=== æ­¥éª¤1: ç”ŸæˆTxDbå¯¹è±¡ ===\n")
# ä½¿ç”¨æ‚¨çš„GTFæ–‡ä»¶ç”Ÿæˆtxdbå¯¹è±¡
gtf_æ–‡ä»¶ <- "Sus_scrofa.Sscrofa11.1.114.chr.gtf.gz"
txdb_file <- file.path(chipseeker_dir, "çŒªåŸºå› ç»„_ChIPseeker_TxDb.sqlite")

if(!file.exists(txdb_file)) {
  cat("æ­£åœ¨ä»GTFæ–‡ä»¶ç”ŸæˆTxDbå¯¹è±¡...\n")
  txdb <- makeTxDbFromGFF(gtf_æ–‡ä»¶)  # å¯¹åº”æ‚¨æåˆ°çš„ä»£ç 
  saveDb(txdb, txdb_file)
  cat("âœ“ TxDbå¯¹è±¡ç”Ÿæˆå¹¶ä¿å­˜å®Œæˆ\n")
} else {
  cat("è¯»å–å·²ä¿å­˜çš„TxDbå¯¹è±¡...\n")
  txdb <- loadDb(txdb_file)
  cat("âœ“ TxDbå¯¹è±¡è¯»å–æˆåŠŸ\n")
}

cat("\n=== æ­¥éª¤2: å‡†å¤‡peakæ–‡ä»¶ ===\n")
# å°†æ‚¨çš„æ•°æ®è½¬æ¢ä¸ºChIPseekerå¯è¯»çš„æ ¼å¼

# å‡½æ•°ï¼šå°†æ•°æ®æ¡†è½¬æ¢ä¸ºpeakæ–‡ä»¶æ ¼å¼
convert_to_peak_format <- function(peak_data, output_file) {
  if(nrow(peak_data) == 0) {
    cat("! æ²¡æœ‰å³°å€¼æ•°æ®\n")
    return(NULL)
  }
  
  # åˆ›å»ºæ ‡å‡†çš„peakæ ¼å¼æ–‡ä»¶ (ç±»ä¼¼narrowPeakæ ¼å¼)
  peak_format <- data.frame(
    seqnames = peak_data$seqnames,
    start = peak_data$start,
    end = peak_data$end,
    name = paste0("Peak_", 1:nrow(peak_data)),
    score = round(-log10(peak_data$FDR) * 100),  # è½¬æ¢FDRä¸ºscore
    strand = ".",
    fold_change = peak_data$Fold,
    pvalue = -log10(peak_data$FDR),
    qvalue = -log10(peak_data$FDR),
    summit = round((peak_data$end - peak_data$start) / 2)  # å³°å€¼ä¸­å¿ƒ
  )
  
  # ä¿å­˜ä¸ºbedæ ¼å¼æ–‡ä»¶
  write.table(peak_format[,1:3], output_file, 
              sep = "\t", row.names = FALSE, col.names = FALSE, quote = FALSE)
  
  cat("âœ“ Peakæ–‡ä»¶å·²ä¿å­˜:", output_file, "\n")
  return(output_file)
}

# è½¬æ¢å®½æ¾é˜ˆå€¼æ•°æ®
if(exists("edgeR_å®½æ¾") && nrow(edgeR_å®½æ¾) > 0) {
  å®½æ¾_peak_file <- file.path(chipseeker_dir, "æ•°æ®", "EdgeR_å®½æ¾é˜ˆå€¼_peaks.bed")
  convert_to_peak_format(edgeR_å®½æ¾, å®½æ¾_peak_file)
} else {
  å®½æ¾_peak_file <- NULL
}

# è½¬æ¢ä¸¥æ ¼é˜ˆå€¼æ•°æ®  
if(exists("edgeR_ä¸¥æ ¼") && nrow(edgeR_ä¸¥æ ¼) > 0) {
  ä¸¥æ ¼_peak_file <- file.path(chipseeker_dir, "æ•°æ®", "EdgeR_ä¸¥æ ¼é˜ˆå€¼_peaks.bed")
  convert_to_peak_format(edgeR_ä¸¥æ ¼, ä¸¥æ ¼_peak_file)
} else {
  ä¸¥æ ¼_peak_file <- NULL
}

cat("\n=== æ­¥éª¤3: ChIPseekeræ³¨é‡Šåˆ†æ ===\n")

# å‡½æ•°ï¼šä½¿ç”¨ChIPseekerè¿›è¡Œæ³¨é‡Š
chipseeker_annotate <- function(peak_file, peak_name, txdb, output_dir) {
  if(is.null(peak_file) || !file.exists(peak_file)) {
    cat(sprintf("! %sçš„peakæ–‡ä»¶ä¸å­˜åœ¨\n", peak_name))
    return(NULL)
  }
  
  cat(sprintf("æ­£åœ¨æ³¨é‡Š %s...\n", peak_name))
  
  tryCatch({
    # æ­¥éª¤1: è¯»å–peakæ–‡ä»¶ (å¯¹åº”æ‚¨æåˆ°çš„readPeakFile)
    peak_data <- readPeakFile(peak_file)
    cat("âœ“ Peakæ–‡ä»¶è¯»å–æˆåŠŸï¼Œå…±", length(peak_data), "ä¸ªå³°å€¼\n")
    
    # æ­¥éª¤2: è¿›è¡Œpeakæ³¨é‡Š (å¯¹åº”æ‚¨æåˆ°çš„annotatePeak)
    peakAnno <- annotatePeak(
      peak_data,
      tssRegion = c(-2000, 2000),  # å¯¹åº”æ‚¨æåˆ°çš„TSSåŒºåŸŸå®šä¹‰
      TxDb = txdb,
      level = "transcript",
      assignGenomicAnnotation = TRUE
    )
    cat("âœ“ Peakæ³¨é‡Šå®Œæˆ\n")
    
    # è·å–æ³¨é‡Šç»“æœ
    anno_result <- as.data.frame(peakAnno)
    
    # æ˜¾ç¤ºæ³¨é‡Šç»Ÿè®¡
    cat("\næ³¨é‡Šç»“æœç»Ÿè®¡:\n")
    anno_summary <- summary(peakAnno)
    print(anno_summary)
    
    # ä¿å­˜æ³¨é‡Šç»“æœ
    write.csv(anno_result, 
              file.path(output_dir, "æ•°æ®", paste0(peak_name, "_ChIPseekeræ³¨é‡Šç»“æœ.csv")), 
              row.names = FALSE)
    
    cat("\n=== æ­¥éª¤4: å¯è§†åŒ–å±•ç¤º ===\n")
    
    # 1. æ³¨é‡Šé¥¼å›¾ (å¯¹åº”æ‚¨æåˆ°çš„plotAnnoPie)
    cat("ç”Ÿæˆæ³¨é‡Šé¥¼å›¾...\n")
    pdf(file.path(output_dir, "å›¾è¡¨", paste0(peak_name, "_æ³¨é‡Šé¥¼å›¾.pdf")), 
        width = 8, height = 6)
    p1 <- plotAnnoPie(peakAnno)  # å¯¹åº”æ‚¨æåˆ°çš„ä»£ç 
    print(p1)
    dev.off()
    
    # 2. æ³¨é‡ŠæŸ±çŠ¶å›¾
    cat("ç”Ÿæˆæ³¨é‡ŠæŸ±çŠ¶å›¾...\n")
    pdf(file.path(output_dir, "å›¾è¡¨", paste0(peak_name, "_æ³¨é‡ŠæŸ±çŠ¶å›¾.pdf")), 
        width = 10, height = 6)
    p2 <- plotAnnoBar(peakAnno)
    print(p2)
    dev.off()
    
    # 3. è·ç¦»TSSåˆ†å¸ƒå›¾
    cat("ç”Ÿæˆè·ç¦»TSSåˆ†å¸ƒå›¾...\n")
    pdf(file.path(output_dir, "å›¾è¡¨", paste0(peak_name, "_è·ç¦»TSSåˆ†å¸ƒ.pdf")), 
        width = 10, height = 6)
    p3 <- plotDistToTSS(peakAnno, title = paste(peak_name, "Distance to TSS"))
    print(p3)
    dev.off()
    
    # 4. åŸºå› ç»„ç‰¹å¾åˆ†å¸ƒçƒ­å›¾
    cat("ç”ŸæˆåŸºå› ç»„ç‰¹å¾çƒ­å›¾...\n")
    pdf(file.path(output_dir, "å›¾è¡¨", paste0(peak_name, "_åŸºå› ç»„ç‰¹å¾çƒ­å›¾.pdf")), 
        width = 12, height = 8)
    tryCatch({
      p4 <- plotAvgProf(peakAnno, TxDb = txdb, upstream = 3000, downstream = 3000)
      print(p4)
    }, error = function(e) {
      cat("çƒ­å›¾ç”Ÿæˆè·³è¿‡ï¼ˆå¯èƒ½éœ€è¦æ›´å¤šå†…å­˜ï¼‰\n")
    })
    dev.off()
    
    cat("âœ“", peak_name, "å¯è§†åŒ–å®Œæˆ\n")
    
    return(list(
      annotation = peakAnno,
      dataframe = anno_result,
      summary = anno_summary
    ))
    
  }, error = function(e) {
    cat("æ³¨é‡Šè¿‡ç¨‹ä¸­å‡ºé”™:", e$message, "\n")
    return(NULL)
  })
}

# æ‰§è¡ŒChIPseekeræ³¨é‡Š
cat(paste(rep("=", 60), collapse=""), "\n")
cat("å¼€å§‹ChIPseekeræ ‡å‡†æ³¨é‡Šæµç¨‹\n")
cat(paste(rep("=", 60), collapse=""), "\n")

# æ³¨é‡Šå®½æ¾é˜ˆå€¼
if(!is.null(å®½æ¾_peak_file)) {
  å®½æ¾_chipseeker <- chipseeker_annotate(å®½æ¾_peak_file, "EdgeR_å®½æ¾é˜ˆå€¼", txdb, chipseeker_dir)
}

# æ³¨é‡Šä¸¥æ ¼é˜ˆå€¼
if(!is.null(ä¸¥æ ¼_peak_file)) {
  ä¸¥æ ¼_chipseeker <- chipseeker_annotate(ä¸¥æ ¼_peak_file, "EdgeR_ä¸¥æ ¼é˜ˆå€¼", txdb, chipseeker_dir)
}

cat("\n=== æ­¥éª¤5: æ¯”è¾ƒåˆ†æ ===\n")
# å¦‚æœä¸¤ä¸ªç»“æœéƒ½å­˜åœ¨ï¼Œè¿›è¡Œæ¯”è¾ƒåˆ†æ
if(exists("å®½æ¾_chipseeker") && exists("ä¸¥æ ¼_chipseeker") && 
   !is.null(å®½æ¾_chipseeker) && !is.null(ä¸¥æ ¼_chipseeker)) {
  
  cat("ç”Ÿæˆæ¯”è¾ƒåˆ†æå›¾è¡¨...\n")
  
  # æ¯”è¾ƒæ³¨é‡Šåˆ†å¸ƒ
  pdf(file.path(chipseeker_dir, "å›¾è¡¨", "å®½æ¾vsä¸¥æ ¼_æ³¨é‡Šæ¯”è¾ƒ.pdf"), 
      width = 14, height = 8)
  
  # å¹¶æ’æ˜¾ç¤ºä¸¤ä¸ªé¥¼å›¾
  par(mfrow = c(1, 2))
  
  plotAnnoPie(å®½æ¾_chipseeker$annotation, main = "EdgeRå®½æ¾é˜ˆå€¼")
  plotAnnoPie(ä¸¥æ ¼_chipseeker$annotation, main = "EdgeRä¸¥æ ¼é˜ˆå€¼")
  
  dev.off()
  
  # æ¯”è¾ƒè·ç¦»åˆ†å¸ƒ
  pdf(file.path(chipseeker_dir, "å›¾è¡¨", "å®½æ¾vsä¸¥æ ¼_è·ç¦»TSSæ¯”è¾ƒ.pdf"), 
      width = 14, height = 6)
  
  par(mfrow = c(1, 2))
  plotDistToTSS(å®½æ¾_chipseeker$annotation, title = "å®½æ¾é˜ˆå€¼ Distance to TSS")
  plotDistToTSS(ä¸¥æ ¼_chipseeker$annotation, title = "ä¸¥æ ¼é˜ˆå€¼ Distance to TSS")
  
  dev.off()
  
  cat("âœ“ æ¯”è¾ƒåˆ†æå®Œæˆ\n")
}

# ä¿å­˜å·¥ä½œç¯å¢ƒ
save.image(file.path(chipseeker_dir, "ChIPseekeræ ‡å‡†æ³¨é‡Šç¯å¢ƒ.RData"))

# ç”Ÿæˆåˆ†ææŠ¥å‘Š
æŠ¥å‘Šå†…å®¹ <- c(
  "=== ChIPseekeræ ‡å‡†æ³¨é‡Šåˆ†ææŠ¥å‘Š ===",
  paste("åˆ†ææ—¶é—´:", Sys.time()),
  paste("ç”¨æˆ·: buyu-ahau"),
  "",
  "=== ä½¿ç”¨çš„ChIPseekeræ ‡å‡†æµç¨‹ ===",
  "1. library(ChIPseeker)",
  "2. library(GenomicFeatures)", 
  "3. txdb <- makeTxDbFromGFF('gene.gtf')",
  "4. peakfile <- readPeakFile('peaks.bed')",
  "5. peakAnno <- annotatePeak(peakfile, tssRegion=c(-2000, 2000), TxDb=txdb)",
  "6. p <- plotAnnoPie(peakAnno)",
  "",
  "=== å‚æ•°è®¾ç½® ===",
  "- TSSåŒºåŸŸ: -2000bp åˆ° +2000bp (å¯¹åº”tssRegion=c(-2000, 2000))",
  "- æ³¨é‡Šçº§åˆ«: transcript",
  "- è‡ªåŠ¨åˆ†é…åŸºå› ç»„æ³¨é‡Šä¼˜å…ˆçº§",
  "",
  "=== ç”Ÿæˆçš„æ–‡ä»¶ ===",
  "æ•°æ®æ–‡ä»¶:",
  "- EdgeR_å®½æ¾é˜ˆå€¼_peaks.bed (peakæ–‡ä»¶)",
  "- EdgeR_ä¸¥æ ¼é˜ˆå€¼_peaks.bed (peakæ–‡ä»¶)", 
  "- EdgeR_å®½æ¾é˜ˆå€¼_ChIPseekeræ³¨é‡Šç»“æœ.csv",
  "- EdgeR_ä¸¥æ ¼é˜ˆå€¼_ChIPseekeræ³¨é‡Šç»“æœ.csv",
  "",
  "å›¾è¡¨æ–‡ä»¶:",
  "- *_æ³¨é‡Šé¥¼å›¾.pdf (plotAnnoPieç»“æœ)",
  "- *_æ³¨é‡ŠæŸ±çŠ¶å›¾.pdf (plotAnnoBarç»“æœ)",
  "- *_è·ç¦»TSSåˆ†å¸ƒ.pdf (plotDistToTSSç»“æœ)",
  "- *_åŸºå› ç»„ç‰¹å¾çƒ­å›¾.pdf (plotAvgProfç»“æœ)",
  "- å®½æ¾vsä¸¥æ ¼_æ³¨é‡Šæ¯”è¾ƒ.pdf",
  "- å®½æ¾vsä¸¥æ ¼_è·ç¦»TSSæ¯”è¾ƒ.pdf"
)

writeLines(æŠ¥å‘Šå†…å®¹, file.path(chipseeker_dir, "ChIPseekeræ ‡å‡†æ³¨é‡ŠæŠ¥å‘Š.txt"))

# æœ€ç»ˆæ€»ç»“
cat("\n")
cat(paste(rep("=", 70), collapse=""))
cat("\n")
cat("ğŸ‰ ChIPseekeræ ‡å‡†æ³¨é‡Šæµç¨‹å®Œæˆï¼\n")
cat(paste(rep("=", 70), collapse=""))
cat("\n")

if(exists("å®½æ¾_chipseeker") && !is.null(å®½æ¾_chipseeker)) {
  cat("ğŸ“Š å®½æ¾é˜ˆå€¼æ³¨é‡Šç»Ÿè®¡:\n")
  print(å®½æ¾_chipseeker$summary)
  cat("\n")
}

if(exists("ä¸¥æ ¼_chipseeker") && !is.null(ä¸¥æ ¼_chipseeker)) {
  cat("ğŸ“Š ä¸¥æ ¼é˜ˆå€¼æ³¨é‡Šç»Ÿè®¡:\n")
  print(ä¸¥æ ¼_chipseeker$summary)
  cat("\n")
}

cat("ğŸ“ æ‰€æœ‰ç»“æœå·²ä¿å­˜åˆ°:", chipseeker_dir, "\n")
cat("ğŸ“‹ å®Œå…¨æŒ‰ç…§æ ‡å‡†ChIPseekeræµç¨‹:\n")
cat("  âœ“ makeTxDbFromGFF() - ç”ŸæˆTxDbå¯¹è±¡\n")
cat("  âœ“ readPeakFile() - è¯»å–peakæ–‡ä»¶\n")
cat("  âœ“ annotatePeak() - è¿›è¡Œæ³¨é‡Š\n")
cat("  âœ“ plotAnnoPie() - ç”Ÿæˆé¥¼å›¾\n")
cat("  âœ“ å…¶ä»–æ ‡å‡†å¯è§†åŒ–å›¾è¡¨\n")

cat("\nğŸ¯ ä»£ç å¯¹åº”å…³ç³»:\n")
cat("  â€¢ æ‚¨çš„GTF â†’ makeTxDbFromGFF('gene.gtf')\n")
cat("  â€¢ æ‚¨çš„å³°å€¼ â†’ readPeakFile('peaks.bed')\n")
cat("  â€¢ TSSÂ±2kb â†’ tssRegion=c(-2000, 2000)\n")
cat("  â€¢ é¥¼å›¾ â†’ plotAnnoPie(peakAnno)\n")

cat("\nåˆ†æå®Œæˆæ—¶é—´:", as.character(Sys.time()), "\n")
